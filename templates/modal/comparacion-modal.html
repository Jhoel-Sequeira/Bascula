{% for verifi in verificacion %}

<div class="modal fade" id="detalleVerificacionmodal" data-bs-focus="true" tabindex="-1"
    aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-fullscreen-lg-down">
        <div class="modal-content" style="background-color: #e4e9f7">
            <div class="modal-header encabezado_modales">
                <h5 class="modal-title fuente-grande-titulo" id="exampleModalLabel">
                    Comparación de verificación
                </h5>
                <button type="button" class="btn-close bg-light" data-bs-dismiss="modal" aria-label="Close"
                    onclick="cargarLista()"></button>
            </div>
            <div id="contener"></div>
            <div class="modal-body fondo-modal">
                <div class="container">
                    <div class="row">
                        <div class="input-valor">
                            <div class="col">
                                <label class="form-label fuentelabel" for="form3Example2"><strong>PO</strong></label>
                                {%if ids%}
                                <input type="hidden" id="varios_id" value="{{ids}}">
                                {%else%}
                                <input type="hidden" id="varios_id" value="">
                                {%endif%}
                                <input type="text" id="po" name="id" style="text-transform: uppercase"
                                    onkeyup="this.value=this.value.toUpperCase()" value="{{ verifi[2] }}"
                                    placeholder="Peso báscula" disabled class="form-control" />

                                <label class="form-label fuentelabel" for="form3Example2"><strong>Tipo de
                                        Material </strong></label>
                                {% if val %}
                                {%for valor in validacion%}
                                <input type="text" id="po" name="id" style="text-transform: uppercase"
                                    onkeyup="this.value=this.value.toUpperCase()" value="{{ valor[2] }}"
                                    placeholder="Peso báscula" disabled class="form-control" />
                                {%endfor%}
                                {%else%}
                                <select class="form-select" id="tmaterial" aria-label="Default select example">
                                    <option selected="selected" hidden>
                                        Seleccionar el material
                                    </option>
                                    <option value="1">No ferroso</option>
                                    <option value="2">PET</option>
                                    <option value="3">Chatarra</option>
                                    <option value="4">Bateria</option>
                                </select>
                                {%endif%}
                            </div>
                            <div class="col">
                                {% if val %}
                                {%for valor in validacion%}
                                <div class="row">
                                    <div class="col">
                                        <label class="form-label fuentelabel" for="form3Example2"><strong>Peso
                                                Báscula</strong></label>

                                        <input type="text" id="pesobascula" name="pesobascula"
                                            style="text-transform: uppercase" disabled value="{{valor[3]}}"
                                            onkeyup="this.value=this.value.toUpperCase()" placeholder="Peso báscula"
                                            required="required" class="form-control" />
                                    </div>
                                    <div class="col">
                                        <label class="form-label fuentelabel" for="form3Example2"><strong>Variación
                                                Báscula</strong></label>

                                        <input type="text" id="var" disabled name="pesobascula"
                                            style="text-transform: uppercase"
                                            onkeyup="this.value=this.value.toUpperCase()" value="{{valor[4]}}"
                                            placeholder="Variación báscula" required="required" class="form-control" />
                                    </div>

                                </div>
                                {%endfor%}
                                {%else%}
                                <div class="row">
                                    <div class="col">
                                        <label class="form-label fuentelabel" for="form3Example2"><strong>Peso
                                                Báscula</strong></label>

                                        <input type="text" id="pesobascula" name="pesobascula"
                                            style="text-transform: uppercase"
                                            onkeyup="this.value=this.value.toUpperCase()" placeholder="Peso báscula"
                                            required="required" class="form-control" />
                                    </div>
                                    <div class="col">
                                        <label class="form-label fuentelabel" for="form3Example2"><strong>Variación
                                                Báscula</strong></label>

                                        <input type="text" id="var" name="pesobascula" style="text-transform: uppercase"
                                            onkeyup="this.value=this.value.toUpperCase()"
                                            placeholder="Variación báscula" required="required" class="form-control" />
                                    </div>

                                </div>
                                {%endif%}
                                <div class="row">
                                    <div class="col">
                                        <label class="form-label fuentelabel" for="form3Example2"><strong>Peso
                                                Neto</strong></label>

                                        <input type="text" id="neto" name="nboleta" style="text-transform: uppercase"
                                            onkeyup="this.value=this.value.toUpperCase()" disabled
                                            placeholder="Peso neto" required="required" class="form-control" value="" />
                                    </div>
                                    <div class="col">
                                        <label class="form-label fuentelabel"
                                            for="form3Example2"><strong>Destare</strong></label>

                                        <input type="text" id="destare" name="nboleta" style="text-transform: uppercase"
                                            onkeyup="this.value=this.value.toUpperCase()" disabled
                                            placeholder="Peso destare" required="required" class="form-control"
                                            value="" />
                                    </div>
                                </div>





                            </div>


                            <div class="col">
                                <div class="row">
                                    <div class="col">
                                        <label class="form-label fuentelabel" for="form3Example2"><strong>Cantidad de
                                                Registro</strong></label>

                                        <input type="text" id="registrosTotal" name="cantidad1"
                                            style="text-transform: uppercase"
                                            onkeyup="this.value=this.value.toUpperCase()" disabled
                                            placeholder="cantidad registro" required="required" class="form-control"
                                            value="" />
                                    </div>
                                    <div class="col">
                                        <div class="row">
                                            <div class="col">
                                                <label class="form-label fuentelabel"
                                                    for="form3Example2"><strong>%</strong></label>

                                                <input type="text" id="porcentaje" name="cantidad"
                                                    style="text-transform: uppercase"
                                                    onkeyup="this.value=this.value.toUpperCase()" disabled
                                                    placeholder="" required="required" class="form-control"
                                                    value="0.3" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>


                        </div>
                        <div id="cuadro" class="cuadro-comparacion">
                            <div style="display: flex; justify-content: center; margin-top: 10px;"><label
                                    class="form-label" style="font-size: 20px;"
                                    for="form3Example2"><strong>VARIACIÓN</strong></label></div>
                            <div style="display: flex; justify-content: center; align-items: center;"><label
                                    class="form-label" id="resultado" style="font-size: 80px;"
                                    for="form3Example2"><strong>00</strong></label></div>


                        </div>
                    </div>
                    <div class="row justify-content-center mt-3">
                        <div class="d-flex justify-content-center">
                            <button type="button" class="btn btn-primary" id="mostrarpesos" onclick="ocultarPesos()"><i
                                    class="fa-solid fa-weight-hanging"></i> Ocultar Pesajes</button>
                        </div>

                    </div>



                </div>

                <input type="hidden" id="id" value="{{ verifi[2] }}" />
                <div class="tab-pane fade show active mt-3 " id="home" role="tabpanel" aria-labelledby="home-tab">
                    <div class="row">
                        <div class="col mt-3 bg-light overflow-scroll" id="tabla-peso"></div>
                    </div>
                </div>

                <!-- INICIO DE LA FUNCIONALIDAD DE LOS BOTONES CON JQUERY  DE LA PRIMERA PANTALLA-->
                <script>
                    flagbloquear = 0;
                    inicio = 1;
                    //FUNCION PARA EL BOTON DE PESOS DE TARAS

                    $(document).ready(function () {
                        $("#totalmat").hide();
                        // MANDAR A LLAMAR LA TABLA
                        //alert($('#totalFilas').text());
                        $('#registrosTotal').val($('#totalFilas').val());
                        cargarPesos();
                        //MANDAMOS A BUSCAR LAS PO
                    });

                    $(document).on("change", "#proveedor", function (event) {
                        valor = $("#proveedor option:selected").val();
                    });
                    //funcion para agregar las taras extras

                    function añadirTara() {
                        idDet = $(this).val();
                        alert(idDet)


                    }

                    function cargarPesos() {
                        if ($('#varios_id').val()) {
                            var JSon = JSON.stringify($('#varios_id').val());
                            // AQUI VA EL AJAX QUE CONTIENE VARIOS IDS
                            alert(JSon)
                            $.ajax({
                                url: "/listaVariosPesos",
                                type: "POST",
                                data: {
                                    id: $('#varios_id').val(),
                                },
                                success: function (response) {
                                    $("#tabla-peso").html(response);
                                    $("#tabla-peso").append(response.htmlresponse);
                                    calcularVariacion();
                                    calcularVariacion1();
                                },
                                error: function (error) {
                                    // console.log(error);
                                },
                            });
                        } else {
                            $.ajax({
                                url: "/listaPesos",
                                type: "POST",
                                data: {
                                    id: $("#id").val(),
                                },
                                success: function (response) {
                                    $("#tabla-peso").html(response);
                                    $("#tabla-peso").append(response.htmlresponse);
                                    calcularVariacion();
                                    calcularVariacion1();
                                },
                                error: function (error) {
                                    // console.log(error);
                                },
                            });
                        }

                    }

                </script>
            </div>
            {% if val %}
            {%else%}
            <div class="p-2">
                <div class="row">
                    <div class="col-6">
                        <button type="button" class="btn btn-success col-12" style="height: 50px" id="finalizar"
                            onclick="finalizar()"><i class="fa-regular fa-circle-check"></i>
                            Validar
                        </button>
                    </div>
                    <div class="col-6">
                        <button type="button" class="btn btn-danger col-12" style="height: 50px" id="finalizar"
                            onclick="finalizarmal()"><i class="fa-solid fa-xmark"></i>
                            Denegar
                        </button>
                    </div>
                </div>
            </div>
            {%endif%}
        </div>
    </div>
</div>

<script>
    var bruto = parseInt($("#bruto").val());
    var tara = parseInt($("#tara").val());
    var destare = parseFloat($("#destare").val());
    $(document).ready(function () {
        $("#bruto").val(0);
        $("#tara").val(0);
        $("#destare").val(0);

    });
    var calcularVariacion = function () {
        var totalRows = $('#registrosTotal').val();
        var calculoPorcentaje = totalRows * 0.3;
        var neto = parseFloat($('#neto').val()) + calculoPorcentaje + parseFloat($('#destare').val());
        if ($("#pesobascula").val() != "") {
            var resultado = parseFloat($('#pesobascula').val()) - (neto - $('#var').val());
            if (resultado < 0) {
                $('#resultado').text('' + resultado.toFixed(2))
                $('#resultado').css('font-weight', 'bold');
                $('#resultado').css('color', 'red');
                $('#cuadro').css('border', '1px solid red');
            } else if (resultado > 0) {
                $('#resultado').text('+' + resultado.toFixed(2))
                $('#resultado').css('font-weight', 'bold');
                $('#resultado').css('color', 'green');
                $('#cuadro').css('border', '1px solid green');
            } else {
                $('#resultado').text('00')
                $('#resultado').css('font-weight', 'bold');
                $('#resultado').css('color', 'black');
                $('#cuadro').css('border', '1px solid black');
            }

        } else {
            $('#resultado').text('00')
            $('#resultado').css('font-weight', 'bold');
            $('#resultado').css('color', 'black');
            $('#cuadro').css('border', '1px solid black');
        }
    }
    $("#pesobascula").on('keyup', calcularVariacion);

    var calcularVariacion1 = function () {
        var totalRows = $('#registrosTotal').val();
        var calculoPorcentaje = totalRows * 0.3;
        var destare = parseFloat($("#destare").val());
        var neto = parseFloat($('#neto').val()) + calculoPorcentaje + parseFloat($('#destare').val());
        if ($("#pesobascula").val() != "") {
            var resultado = parseFloat($('#pesobascula').val()) - (neto - $('#var').val());
            if (resultado < 0) {
                $('#resultado').text('' + resultado.toFixed(2))
                $('#resultado').css('font-weight', 'bold');
                $('#resultado').css('color', 'red');
                $('#cuadro').css('border', '1px solid red');
            } else if (resultado > 0) {
                $('#resultado').text('+' + resultado.toFixed(2))
                $('#resultado').css('font-weight', 'bold');
                $('#resultado').css('color', 'green');
                $('#cuadro').css('border', '1px solid green');
            } else {
                $('#resultado').text('00')
                $('#resultado').css('font-weight', 'bold');
                $('#resultado').css('color', 'black');
                $('#cuadro').css('border', '1px solid black');
            }

        } else {
            $('#resultado').text('00')
            $('#resultado').css('font-weight', 'bold');
            $('#resultado').css('color', 'black');
            $('#cuadro').css('border', '1px solid black');
        }
    }
    $("#var").on('keyup', calcularVariacion1);


    function ocultarPesos() {
        if ($('#home').is(':visible')) {
            $('#home').hide();
            $('#mostrarpesos').text('')
            $('#mostrarpesos').append('<i class="fa-solid fa-weight-hanging"></i>');
            $('#mostrarpesos').append(' Ver Pesajes');
        } else {
            $('#home').show();
            $('#mostrarpesos').text('')
            $('#mostrarpesos').append('<i class="fa-solid fa-weight-hanging"></i>');
            $('#mostrarpesos').append(' Ocultar Pesajes');
        }
    }

    //VALIDACION TARA
    //   $("#bruto").on("keyup", function () {
    //     var bruto1 = parseInt($("#bruto").val());
    //     var tara1 = parseInt($("#tara").val());
    //     var destare1 = parseInt($("#destare").val());
    //     var resta = bruto1 - tara1;

    //     if (bruto1 < 0) {
    //       $("#mensaje_error_peso_bruto").html("El peso no puede ser 0 o inferior.");
    //       $("#mensaje_error_peso_destare").show();
    //     } else if (tara1 > bruto1) {
    //       $("#mensaje_error_peso_bruto").html(
    //         "El peso no puede ser igual o menor al peso tara."
    //       );
    //       $("#mensaje_error_peso_destare").show();
    //     } else if (bruto1 <= destare1) {
    //       $("#mensaje_error_peso_bruto").html(
    //         "El peso no puede ser menor al destare."
    //       );
    //       $("#mensaje_error_peso_destare").show();
    //     } else if (bruto1 - tara1 < destare1) {
    //       $("#mensaje_error_peso_bruto").html(
    //         "El destare no puede ser mayor a la resta de la tara y el peso bruto."
    //       );
    //       $("#mensaje_error_peso_destare").show();
    //     } else {
    //       $("#mensaje_error_peso_destare").hide();
    //       $("#mensaje_error_peso_bruto").hide();
    //       $("#mensaje_error_peso_tara").hide();
    //     }
    //   });
    //   function validartara() {
    //     var bruto1 = parseInt($("#bruto").val());
    //     var tara1 = parseInt($("#tara").val());
    //     var destare1 = parseInt($("#destare").val());
    //     var resta = bruto1 - tara1;

    //     if (tara1 < 0) {
    //       $("#mensaje_error_peso_tara").html("El peso no puede ser 0 o inferior.");
    //       $("#mensaje_error_peso_tara").show();
    //     } else if (tara1 > bruto1) {
    //       $("#mensaje_error_peso_tara").html(
    //         "El peso no puede ser igual o mayor al peso bruto."
    //       );
    //       $("#mensaje_error_peso_tara").show();
    //     } else if (tara1 <= destare1) {
    //       $("#mensaje_error_peso_tara").html(
    //         "El peso no puede ser menor al destare."
    //       );
    //       $("#mensaje_error_peso_tara").show();
    //     } else if (bruto1 - tara1 < destare1) {
    //       $("#mensaje_error_peso_tara").html(
    //         "El destare no puede ser mayor a la resta de la tara y el peso bruto."
    //       );
    //       $("#mensaje_error_peso_tara").show();
    //     } else {
    //       $("#mensaje_error_peso_destare").hide();
    //       $("#mensaje_error_peso_bruto").hide();
    //       $("#mensaje_error_peso_tara").hide();
    //     }
    //   }
    //   $("#tara").on("keyup", validartara);
    //   $("#destare").on("keyup", function () {
    //     var bruto2 = parseInt($("#bruto").val());
    //     var tara2 = parseInt($("#tara").val());
    //     var destare2 = parseInt($("#destare").val());
    //     if (destare2 < 0) {
    //       $("#mensaje_error_peso_destare").html(
    //         "El peso no puede ser 0 o inferior."
    //       );
    //       $("#mensaje_error_peso_destare").show();
    //     } else if (destare2 >= bruto2 || destare2 >= tara2) {
    //       $("#mensaje_error_peso_destare").html(
    //         "El peso no puede ser igual o mayor al peso bruto ni destare."
    //       );
    //       $("#mensaje_error_peso_destare").show();
    //     } else if (bruto2 - tara2 <= destare2) {
    //       $("#mensaje_error_peso_destare").html(
    //         "El destare no puede ser mayor a la resta de la tara y el peso bruto."
    //       );
    //       $("#mensaje_error_peso_destare").show();
    //     } else {
    //       $("#mensaje_error_peso_destare").hide();
    //       $("#mensaje_error_peso_bruto").hide();
    //       $("#mensaje_error_peso_tara").hide();
    //     }
    //   });
    //###########################

    function finalizar() {
        if ($('#pesobascula').val() != 0 && $("#tmaterial option:selected").val() != "Seleccionar el material") {
            Swal.fire({
                title: "¿Desea Validar?",
                text: "Se imprimira una verificación con los detalles",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Sí, aceptar",
                cancelButtonText: "Cancelar",
            }).then((resultado) => {
                if (resultado.value) {
                    $.ajax({
                        url: "/finalizarVerificacion",
                        type: "POST",
                        data: {
                            id: $("#idboleta").val(),
                            tipo: $('#tmaterial option:selected').text(),
                            peso: $('#pesobascula').val(),
                            variacion1: $('#var').val(),
                            variacion2: $('#resultado').text(),
                        },
                        success: function (response) {
                            if (response == "vacio") {
                                Swal.fire({
                                    icon: "warning",
                                    title: "Datos faltantes",
                                    confirmButtonText: "Ok",
                                    text: "Esta verificación no posee pesajes",
                                }).then((result) => {
                                    /* Read more about isConfirmed, isDenied below */
                                    if (result.isConfirmed) {
                                    }
                                });
                            } else {
                                Swal.fire({
                                    icon: "success",
                                    title: "Verificación validada",
                                    confirmButtonText: "Ok",
                                    text: "Se validó la verificación.",
                                }).then((result) => {
                                    /* Read more about isConfirmed, isDenied below */
                                    if (result.isConfirmed) {
                                        window.location = "/home";
                                    }
                                });
                            }
                        },
                        error: function (error) {
                            // console.log(error);
                        },
                    });
                } else {
                    // Dijeron que no
                    console.log("*NO se elimina la venta*");
                }
            });
        } else {
            Swal.fire({
                icon: "error",
                title: "Datos faltantes",
                confirmButtonText: "Ok",
                text: "Debe Añadir los datos faltantes",
            }).then((result) => {
                /* Read more about isConfirmed, isDenied below */
                if (result.isConfirmed) {
                }
            });
        }

    }
    function finalizarmal() {
        Swal.fire({
            title: "¿Desea Validar?",
            text: "Esta verificaciones no coinciden",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Sí, aceptar",
            cancelButtonText: "Cancelar",
        }).then((resultado) => {
            if (resultado.value) {
                $.ajax({
                    url: "/finalizarVerificacionmal",
                    type: "POST",
                    data: {
                        id: $("#idboleta").val(),
                        tipo: $('#tmaterial option:selected').text(),
                        peso: $('#pesobascula').val(),
                        variacion1: $('#var').val(),
                        variacion2: $('#resultado').text(),
                    },
                    success: function (response) {
                        var link = $('<a></a>').text('Ir a Google');
                        link.attr('href', 'https://wa.me/50589940240?text=Favor%20cancelar%20esta%20verificación%20\nPO:' + String($("#po").val()) + '.');
                        link.attr('target', '_blank');
                        link.attr('class', 'd-none');
                        link.appendTo('#contener');
                        setTimeout(function () {
                            link.get(0).click();
                            Swal.fire({
                                icon: "success",
                                title: "Verificación cancelada",
                                confirmButtonText: "Ok",
                                text: "Se canceló la verificación.",
                            }).then((result) => {
                                //establece el valor del href utilizando el método attr()
                                // $('#whatsapp').click();
                                // /* Read more about isConfirmed, isDenied below */
                                if (result.isConfirmed) {
                                    // $('#whatsapp').click();
                                    window.location = "/home";
                                }
                            });
                        }, 100);


                        // setTimeout(() => {
                        //     Swal.fire({
                        //         icon: "success",
                        //         title: "Verificación cancelada",
                        //         confirmButtonText: "Ok",
                        //         text: "Se canceló la verificación.",
                        //     }).then((result) => {
                        //         //establece el valor del href utilizando el método attr()
                        //         // $('#whatsapp').click();
                        //         // /* Read more about isConfirmed, isDenied below */
                        //         if (result.isConfirmed) {
                        //             // $('#whatsapp').click();
                        //             window.location = "/home";
                        //         }
                        //     });
                        // }, 1000);
                    },
                    error: function (error) {
                        // console.log(error);
                    },
                });
            } else {
                // Dijeron que no
                console.log("*NO se elimina la venta*");
            }
        });
    }
</script>

{% endfor %}